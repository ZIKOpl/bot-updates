<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard â€” Bot Updates</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <nav class="nav">
    <div class="brand">
      <div class="logo"></div>
      <h1>Dashboard</h1>
    </div>
    <div class="actions">
      <a href="/" class="btn ghost">Accueil</a>
      <a href="/logout" class="btn danger">Se dÃ©connecter</a>
    </div>
  </nav>

  <main class="container">
    <section class="hero">
      <h1>ğŸ“¤ Panneau dâ€™administration</h1>
      <p>DÃ©posez la nouvelle version de votre bot ci-dessous pour la publier.</p>
    </section>

    <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
      <input type="text" name="version" placeholder="Version (ex: 2.3)" required />
      <div id="dropZone" class="drop-zone">
        <p id="uploadText">Glissez-dÃ©posez votre ZIP ici ou cliquez pour choisir un fichier</p>
        <input type="file" id="fileInput" name="file" accept=".zip" hidden required />
      </div>
      <button type="submit" class="btn primary">ğŸ“¦ TÃ©lÃ©charger la mise Ã  jour</button>
    </form>

    <div class="grid" style="margin-top:2rem;">
      <div class="card">
        <h2>ğŸ“ˆ Historique des versions</h2>
        <canvas id="relChart"></canvas>
      </div>

      <div class="card">
        <h2>ğŸ•’ Versions publiÃ©es</h2>
        <div class="release-list">
          <% if (releases && releases.length > 0) { %>
            <% releases.forEach(r => { %>
              <div class="release-item">
                <span>v<%= r.version %></span>
                <span><%= (r.size / 1024 / 1024).toFixed(2) %> Mo</span>
              </div>
            <% }) %>
          <% } else { %>
            <p class="empty">Aucune version publiÃ©e</p>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>Â© 2025 Bot Updates â€” Panneau dâ€™administration</p>
  </footer>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const txt = document.getElementById("uploadText");
      const form = document.getElementById("uploadForm");

      dropZone.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", e => {
        const file = e.target.files[0];
        if (file) txt.textContent = `ğŸ“¦ ${file.name}`;
      });

      dropZone.addEventListener("dragover", e => {
        e.preventDefault();
        dropZone.classList.add("hover");
      });
      dropZone.addEventListener("dragleave", () => dropZone.classList.remove("hover"));
      dropZone.addEventListener("drop", e => {
        e.preventDefault();
        dropZone.classList.remove("hover");
        const file = e.dataTransfer.files[0];
        if (file) {
          fileInput.files = e.dataTransfer.files;
          txt.textContent = `ğŸ“¦ ${file.name}`;
        }
      });

      form.addEventListener("submit", async e => {
        e.preventDefault();
        const formData = new FormData(form);
        txt.textContent = "â³ Envoi en cours...";

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload");

        xhr.onload = () => {
          if (xhr.status === 200) {
            txt.textContent = "âœ… Upload terminÃ©";
            setTimeout(() => window.location.reload(), 1000);
          } else txt.textContent = "âŒ Erreur : " + xhr.responseText;
        };

        xhr.onerror = () => txt.textContent = "âŒ Erreur rÃ©seau.";
        xhr.send(formData);
      });

      // âœ… Fix Render : parser les donnÃ©es serveur
      const rel = JSON.parse('<%- JSON.stringify(releases || []) %>');
      const ctx = document.getElementById("relChart");
      if (!ctx || !rel.length) return;

      const labels = rel.map(r => "v" + r.version);
      const values = rel.map(r => Number((r.size / 1024 / 1024).toFixed(2)));

      new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Taille du build (Mo)",
            data: values,
            backgroundColor: "#6c8cff"
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: "#ddd" } }
          },
          scales: {
            x: { ticks: { color: "#ccc" } },
            y: { ticks: { color: "#ccc" } }
          }
        }
      });
    });
  </script>
</body>
</html>
