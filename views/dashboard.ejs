<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Dashboard â€“ Bot Updates</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("uploadForm");
      const txt = document.getElementById("uploadText");
      const input = document.getElementById("fileInput");

      // ğŸ–±ï¸ Drag & Drop
      const dropZone = document.querySelector(".drop-zone");
      dropZone.addEventListener("click", () => input.click());
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("hover");
      });
      dropZone.addEventListener("dragleave", () => dropZone.classList.remove("hover"));
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("hover");
        const file = e.dataTransfer.files[0];
        if (file) {
          input.files = e.dataTransfer.files;
          txt.textContent = "ğŸ“¦ Fichier sÃ©lectionnÃ© : " + file.name;
        }
      });

      input.addEventListener("change", () => {
        if (input.files.length)
          txt.textContent = "ğŸ“¦ Fichier sÃ©lectionnÃ© : " + input.files[0].name;
      });

      // ğŸ“¤ Upload
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload");
        txt.textContent = "â³ Upload en cours...";

        xhr.onload = () => {
          if (xhr.status === 200) {
            txt.textContent = "âœ… Upload terminÃ©";
            setTimeout(() => window.location.reload(), 1000);
          } else alert("Erreur : " + xhr.responseText);
        };
        xhr.onerror = () => alert("Erreur rÃ©seau.");
        xhr.send(formData);
      });

      // ğŸ“Š Graphique
      const rel = <%- JSON.stringify(releases || []) %>;
      const ctx = document.getElementById("relChart");
      if (ctx && rel.length) {
        const labels = rel.map(r => r.version);
        const values = rel.map(r => Number((r.size / 1024 / 1024).toFixed(2)));

        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Taille (Mo)",
              data: values,
              backgroundColor: "#6c8cff"
            }]
          },
          options: {
            plugins: { legend: { labels: { color: "#ddd" } } },
            scales: {
              x: { ticks: { color: "#ccc" } },
              y: { ticks: { color: "#ccc" } }
            }
          }
        });
      }
    });
  </script>
</head>

<body>
  <header class="nav">
    <div class="brand"><div class="logo"></div><span>Bot Updates</span></div>
    <nav class="actions">
      <a class="btn ghost" href="/">Accueil</a>
      <a class="btn danger" href="/logout">DÃ©connexion</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero">
      <h1>ğŸ› ï¸ Tableau de bord</h1>
      <p>Bienvenue <%= user.username %> !</p>
      <div class="version-pill">Version actuelle : <strong><%= version %></strong></div>
    </section>

    <section class="card">
      <h2>â¬†ï¸ Mettre en ligne une nouvelle version</h2>
      <form id="uploadForm" enctype="multipart/form-data" class="upload-form">
        <div class="drop-zone">
          <input id="fileInput" type="file" name="updateZip" accept=".zip" hidden />
          <p id="uploadText">Glissez un fichier ZIP ici ou cliquez pour parcourir</p>
        </div>
        <input type="text" name="version" placeholder="Nom de la version (ex: v2.4)" required />
        <button class="btn primary" type="submit">ğŸ“¤ Envoyer</button>
      </form>
    </section>

    <section class="grid">
      <div class="card">
        <h2>ğŸ“Š Historique des versions</h2>
        <% if (releases.length) { %>
          <canvas id="relChart" height="150"></canvas>
          <ul class="release-list">
            <% releases.forEach(r => { %>
              <li>ğŸ“¦ <strong><%= r.version %></strong> â€” <%= (r.size / 1024 / 1024).toFixed(2) %> Mo</li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="empty">Aucune version disponible.</p>
        <% } %>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span>Â© <script>document.write(new Date().getFullYear())</script> Bot Updates</span>
  </footer>
</body>
</html>
