<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Dashboard â€” Bot Updates</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/public/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const drop = document.getElementById("dropzone");
      const input = document.getElementById("file");
      const badge = document.getElementById("fileBadge");
      const form = document.getElementById("uploadForm");
      const versionInput = document.getElementById("version");
      const progress = document.getElementById("progress");
      const bar = progress.querySelector(".bar");
      const txt = progress.querySelector(".txt");

      const setBadge = (name) => {
        badge.textContent = name || "Aucun fichier sÃ©lectionnÃ©";
        badge.classList.toggle("has", !!name);
      };

      input.addEventListener("change", e => setBadge(e.target.files[0]?.name));
      drop.addEventListener("click", () => input.click());

      ["dragenter", "dragover"].forEach(ev => {
        drop.addEventListener(ev, e => {
          e.preventDefault();
          drop.classList.add("active");
        });
      });
      ["dragleave", "drop"].forEach(ev => {
        drop.addEventListener(ev, e => {
          e.preventDefault();
          drop.classList.remove("active");
        });
      });
      drop.addEventListener("drop", e => {
        if (e.dataTransfer.files?.length) {
          input.files = e.dataTransfer.files;
          setBadge(input.files[0].name);
        }
      });

      form.addEventListener("submit", async e => {
        e.preventDefault();
        if (!input.files.length) return alert("SÃ©lectionne un fichier .zip");
        if (!versionInput.value.trim()) return alert("Renseigne une version (ex: v2.3)");

        progress.style.display = "block";
        bar.style.width = "0%";
        txt.textContent = "0%";

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload");

        xhr.upload.onprogress = e => {
          if (e.lengthComputable) {
            const percent = Math.floor((e.loaded / e.total) * 100);
            bar.style.width = percent + "%";
            txt.textContent = percent + "%";
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            txt.textContent = "âœ… Upload terminÃ©";
            setTimeout(() => window.location.reload(), 1000);
          } else alert("Erreur : " + xhr.responseText);
        };
        xhr.onerror = () => alert("Erreur rÃ©seau.");
        xhr.send(formData);
      });

      const rel = <%= JSON.stringify(releases || []) %>;
      const ctx = document.getElementById("relChart");
      if (ctx && rel.length) {
        const labels = rel.map(r => r.version);
        const values = rel.map(r => Number((r.size / 1024 / 1024).toFixed(2)));

        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Taille (Mo)",
              data: values,
              backgroundColor: "#6c8cff",
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: "#ccc" } },
              y: { ticks: { color: "#ccc" }, beginAtZero: true }
            }
          }
        });
      }
    });
  </script>
</head>

<body>
  <header class="nav">
    <div class="brand"><div class="logo"></div> <span>Bot Updates</span></div>
    <nav class="actions">
      <a class="btn ghost" href="/">Accueil</a>
      <a class="btn danger" href="/logout">Se dÃ©connecter</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero small">
      <h1>Panel dâ€™administration</h1>
      <p>Glisse ton .zip pour publier une nouvelle version.</p>
      <div class="version-pill">Version actuelle : <strong><%= version %></strong></div>
    </section>

    <section class="grid admin">
      <div class="card">
        <h2>ðŸ“¦ Nouvelle release</h2>
        <form id="uploadForm" enctype="multipart/form-data">
          <div id="dropzone" class="drop">
            <div class="title">Glisse ton fichier ici</div>
            <div class="subtitle">ou clique pour parcourir</div>
            <div class="badge" id="fileBadge">Aucun fichier sÃ©lectionnÃ©</div>
            <input type="file" id="file" name="updateZip" accept=".zip" hidden />
          </div>

          <div class="row">
            <label for="version">NumÃ©ro de version</label>
            <input id="version" name="version" placeholder="ex: v2.4" required />
          </div>

          <div id="progress" class="progress" style="display:none;">
            <div class="bar"></div>
            <div class="txt">0%</div>
          </div>

          <button class="btn success">Publier</button>
        </form>
      </div>

      <div class="card">
        <h2>ðŸ“ˆ Historique des versions</h2>
        <canvas id="relChart" height="160"></canvas>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span>Â© <script>document.write(new Date().getFullYear())</script> Bot Updates</span>
  </footer>
</body>
</html>
