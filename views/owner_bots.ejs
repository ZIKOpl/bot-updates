<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>GESTION DES BOTS • HOME UPDATE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body class="dash">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <img src="/logo.png" alt="HOME UPDATE" class="sidebar-logo" />
      <span>HOME UPDATE</span>
    </div>
    <nav class="sidebar-nav">
      <a href="/dashboard">RELEASES</a>
      <a href="/owner/bots" class="active">MES BOTS</a>
      <a href="/trash">CORBEILLE</a>
      <a href="/">ACCUEIL</a>
    </nav>
    <div class="sidebar-bottom">
      <a href="/logout" class="danger">DÉCONNEXION</a>
    </div>
  </aside>

  <main class="dash-content">
    <header class="page-header">
      <h1>GESTION DES BOTS</h1>
      <p>LISTE DES BOTS QUI UTILISENT LE SYSTÈME DE MISE À JOUR.</p>
      <div style="margin-top:10px;">
        <span class="version-pill">DERNIÈRE VERSION DISPONIBLE : <strong><%= latestVersion %></strong></span>
      </div>
    </header>

    <div class="top-actions">
      <button class="btn primary" type="button" onclick="openModal()">AJOUTER UN BOT</button>
    </div>

    <section class="bots-grid">
      <% if (bots.length === 0) { %>
        <p class="muted">Aucun bot enregistré.</p>
      <% } else { %>
        <% bots.forEach(bot => {
             const stats = bot.stats || {};
             const currentVersion = stats.botVersion || "Inconnue";
             const isUpToDate = currentVersion === latestVersion;
        %>
          <div class="bot-card" data-id="<%= bot._id %>">
            <div class="bot-header">
              <div class="bot-title">
                <span class="bot-name"><%= bot.name %></span>
                <span class="bot-sub">Propriétaire : <%= bot.ownerId || "Inconnu" %></span>
                <span class="bot-sub">Version bot : <%= currentVersion %></span>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                <div>
                  <% if (currentVersion !== "Inconnue") { %>
                    <% if (isUpToDate) { %>
                      <span class="tag tag-success">À JOUR</span>
                    <% } else { %>
                      <span class="tag tag-warn">OBSOLÈTE</span>
                    <% } %>
                  <% } else { %>
                    <span class="tag tag-muted">AUCUNE INFO VERSION</span>
                  <% } %>
                </div>
                <div class="bot-actions">
                  <button class="btn small" type="button" onclick="showToken('<%= bot._id %>')">VOIR TOKEN</button>
                  <button class="btn small" type="button" onclick="forceRestart('<%= bot._id %>')">REDÉMARRER</button>
                  <button class="btn small" type="button" onclick="forceUpdate('<%= bot._id %>')">FORCER MISE À JOUR</button>
                  <form action="/owner/bots/<%= bot._id %>/delete" method="POST" style="display:inline;"
                        onsubmit="return confirm('Supprimer ce bot ?');">
                    <button type="submit" class="btn danger small">SUPPRIMER</button>
                  </form>
                </div>
              </div>
            </div>
            <div class="bot-details">
              <p><strong>Ajouté le :</strong> <%= new Date(bot.createdAt).toLocaleString("fr-FR") %></p>
              <p><strong>Dernier READY :</strong> <%= stats.lastReady ? new Date(stats.lastReady).toLocaleString("fr-FR") : "Jamais" %></p>
              <p><strong>Dernier check :</strong> <%= stats.lastCheck ? new Date(stats.lastCheck).toLocaleString("fr-FR") : "Jamais" %></p>
              <p><strong>Redémarrages :</strong> <%= stats.restarts || 0 %></p>
              <p><strong>Erreurs :</strong> <%= stats.errors || 0 %></p>
              <% if (bot.meta && bot.meta.notes) { %>
                <p><strong>Notes :</strong> <%= bot.meta.notes %></p>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } %>
    </section>
  </main>

  <footer class="footer">
    © <%= new Date().getFullYear() %> — HOME UPDATE PANEL ·
    <a href="<%= support %>" target="_blank" rel="noopener">DISCORD SUPPORT</a>
  </footer>

  <!-- Modal ajout bot -->
  <div id="bot-modal" class="modal hidden">
    <div class="modal-box">
      <h2>AJOUTER UN BOT</h2>
      <form action="/owner/bots/add" method="POST">
        <input class="input" type="text" name="name" placeholder="Nom du bot" required />
        <input class="input" type="text" name="ownerId" placeholder="ID Discord du propriétaire (optionnel)" />
        <input class="input" type="text" name="tokenPlain" placeholder="Token du bot" required />
        <textarea class="input textarea" name="notes" rows="3" placeholder="Notes (serveur, usage, etc.)"></textarea>
        <div class="modal-actions">
          <button type="button" class="btn" onclick="closeModal()">ANNULER</button>
          <button type="submit" class="btn primary">AJOUTER</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ouverture/fermeture détails
    document.querySelectorAll('.bot-header').forEach(h => {
      h.addEventListener('click', (e) => {
        if (e.target.closest('button') || e.target.closest('form')) return;
        h.parentElement.classList.toggle('open');
      });
    });

    // modal
    function openModal() {
      document.getElementById('bot-modal').classList.remove('hidden');
    }
    function closeModal() {
      document.getElementById('bot-modal').classList.add('hidden');
    }

    // voir token
    async function showToken(id) {
      try {
        const res = await fetch(`/owner/bots/${id}/decrypt`);
        if (!res.ok) return alert("Erreur lors de la récupération du token.");
        const data = await res.json();
        alert(`Token de ${data.name} :\n\n${data.token}`);
      } catch (e) {
        alert("Erreur réseau lors de la récupération du token.");
      }
    }

    // à implémenter côté backend
    function forceRestart(id) {
      alert("Redémarrage à implémenter côté backend (/owner/bots/"+id+"/restart).");
    }

    function forceUpdate(id) {
      alert("Mise à jour forcée à implémenter côté backend (/owner/bots/"+id+"/force-update).");
    }
  </script>
</body>
</html>
