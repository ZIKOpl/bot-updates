<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Gestion des bots ‚Ä¢ HOME UPDATE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .bots-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      margin-bottom: 40px;
      justify-content: center;
    }
    .bot-card {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.08);
      padding: 14px 16px;
      width: 100%;
      max-width: 520px;
      transition: .2s ease;
    }
    .bot-card.open {
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
    }
    .bot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      gap: 12px;
    }
    .bot-title {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .bot-name {
      font-weight: 700;
      font-size: 0.98rem;
    }
    .bot-sub {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .bot-details {
      display: none;
      padding-top: 8px;
      margin-top: 8px;
      border-top: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 0.9rem;
    }
    .bot-card.open .bot-details {
      display: block;
    }
    .bot-actions button,
    .bot-actions .btn {
      margin-left: 6px;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid transparent;
      gap: 4px;
    }
    .tag-success {
      background: rgba(34, 197, 94, 0.06);
      color: #15803d;
      border-color: rgba(34, 197, 94, 0.35);
    }
    .tag-warn {
      background: rgba(234, 179, 8, 0.08);
      color: #92400e;
      border-color: rgba(234, 179, 8, 0.4);
    }
    .tag-muted {
      background: rgba(148, 163, 184, 0.15);
      color: #4b5563;
      border-color: rgba(148, 163, 184, 0.5);
    }

    /* modal simple */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.48);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal.hidden { display:none; }
    .modal-box {
      background:#fff;
      border-radius:18px;
      padding:20px 22px;
      max-width:420px;
      width:100%;
      box-shadow:0 20px 50px rgba(15,23,42,.35);
    }
    .modal-actions {
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
  </style>
</head>
<body class="dash">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <img src="/logo.png" alt="HOME UPDATE" class="sidebar-logo" />
      <span>HOME UPDATE</span>
    </div>
    <nav class="sidebar-nav">
      <a href="/dashboard">üì¶ Releases</a>
      <a href="/owner/bots" class="active">ü§ñ Mes Bots</a>
      <a href="/trash">üóëÔ∏è Corbeille</a>
      <a href="/">üè† Accueil</a>
    </nav>
    <div class="sidebar-bottom">
      <a href="/logout" class="danger">üö™ D√©connexion</a>
    </div>
  </aside>

  <main class="dash-content">
    <header class="page-header">
      <h1>ü§ñ Gestion des Bots</h1>
      <p>Liste compl√®te des bots enregistr√©s utilisant le syst√®me de mise √† jour.</p>
      <div style="margin-top:10px;">
        <span class="version-pill">Derni√®re version disponible : <strong><%= latestVersion %></strong></span>
      </div>
    </header>

    <div class="top-actions">
      <button class="btn primary" type="button" onclick="openModal()">‚ûï Ajouter un bot</button>
    </div>

    <section class="bots-grid">
      <% if (bots.length === 0) { %>
        <p class="muted">Aucun bot enregistr√©.</p>
      <% } else { %>
        <% bots.forEach(bot => { 
             const stats = bot.stats || {};
             const currentVersion = stats.botVersion || "Inconnue";
             const isUpToDate = currentVersion === latestVersion;
        %>
          <div class="bot-card" data-id="<%= bot._id %>">
            <div class="bot-header">
              <div class="bot-title">
                <span class="bot-name"><%= bot.name %></span>
                <span class="bot-sub">Propri√©taire : <%= bot.ownerId || "Inconnu" %></span>
                <span class="bot-sub">Version bot : <%= currentVersion %></span>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                <div>
                  <% if (currentVersion !== "Inconnue") { %>
                    <% if (isUpToDate) { %>
                      <span class="tag tag-success">√Ä jour</span>
                    <% } else { %>
                      <span class="tag tag-warn">Obsol√®te</span>
                    <% } %>
                  <% } else { %>
                    <span class="tag tag-muted">Aucune info version</span>
                  <% } %>
                </div>
                <div class="bot-actions">
                  <button class="btn small" type="button" onclick="showToken('<%= bot._id %>')">üîê Voir Token</button>
                  <button class="btn small" type="button" onclick="forceRestart('<%= bot._id %>')">üîÑ Red√©marrer</button>
                  <button class="btn small" type="button" onclick="forceUpdate('<%= bot._id %>')">‚¨Ü Forcer m√†j</button>
                  <form action="/owner/bots/<%= bot._id %>/delete" method="POST" style="display:inline;"
                        onsubmit="return confirm('Supprimer ce bot ?');">
                    <button type="submit" class="btn danger small">üóëÔ∏è Supprimer</button>
                  </form>
                </div>
              </div>
            </div>
            <div class="bot-details">
              <p><strong>Ajout√© le :</strong> <%= new Date(bot.createdAt).toLocaleString("fr-FR") %></p>
              <p><strong>Dernier READY :</strong> <%= stats.lastReady ? new Date(stats.lastReady).toLocaleString("fr-FR") : "Jamais" %></p>
              <p><strong>Dernier check :</strong> <%= stats.lastCheck ? new Date(stats.lastCheck).toLocaleString("fr-FR") : "Jamais" %></p>
              <p><strong>Red√©marrages :</strong> <%= stats.restarts || 0 %></p>
              <p><strong>Erreurs :</strong> <%= stats.errors || 0 %></p>
              <% if (bot.meta && bot.meta.notes) { %>
                <p><strong>Notes :</strong> <%= bot.meta.notes %></p>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } %>
    </section>
  </main>

  <footer class="footer">
    ¬© <%= new Date().getFullYear() %> ‚Äî HOME UPDATE Panel ¬∑
    <a href="<%= support %>" target="_blank" rel="noopener">Discord</a>
  </footer>

  <!-- Modal ajout bot -->
  <div id="bot-modal" class="modal hidden">
    <div class="modal-box">
      <h2>Ajouter un bot</h2>
      <form action="/owner/bots/add" method="POST">
        <input class="input" type="text" name="name" placeholder="Nom du bot (ex : Smiddy)" required />
        <input class="input" type="text" name="ownerId" placeholder="ID Discord du propri√©taire (optionnel)" />
        <input class="input" type="text" name="tokenPlain" placeholder="Token du bot" required />
        <textarea class="input textarea" name="notes" rows="3" placeholder="Notes (serveur, usage, etc.)"></textarea>
        <div class="modal-actions">
          <button type="button" class="btn" onclick="closeModal()">Annuler</button>
          <button type="submit" class="btn primary">Ajouter</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.querySelectorAll('.bot-header').forEach(h => {
      h.addEventListener('click', (e) => {
        if (e.target.closest('button') || e.target.closest('form')) return;
        h.parentElement.classList.toggle('open');
      });
    });

    async function showToken(id) {
      try {
        const res = await fetch(`/owner/bots/${id}/decrypt`);
        if (!res.ok) return alert("Erreur lors de la r√©cup√©ration du token.");
        const data = await res.json();
        alert(`Token de ${data.name} :\n\n${data.token}`);
      } catch (e) {
        alert("Erreur r√©seau lors de la r√©cup√©ration du token.");
      }
    }

    function forceRestart(id) {
      alert("üîÑ Bouton red√©marrer : √† impl√©menter c√¥t√© backend (route /owner/bots/" + id + "/restart).");
    }

    function forceUpdate(id) {
      alert("‚¨Ü Bouton forcer mise √† jour : √† impl√©menter c√¥t√© backend (route /owner/bots/" + id + "/force-update).");
    }

    function openModal() {
      document.getElementById('bot-modal').classList.remove('hidden');
    }
    function closeModal() {
      document.getElementById('bot-modal').classList.add('hidden');
    }
  </script>
</body>
</html>
