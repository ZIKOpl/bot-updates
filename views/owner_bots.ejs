<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Gestion des bots â€¢ HOME UPDATE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body class="dash">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <img src="/logo.png" alt="HOME UPDATE" class="sidebar-logo" />
      <span>HOME UPDATE</span>
    </div>
    <nav class="sidebar-nav">
      <a href="/dashboard">ğŸ“¦ Releases</a>
      <a href="/owner/bots" class="active">ğŸ¤– Mes Bots</a>
      <a href="/trash">ğŸ—‘ï¸ Corbeille</a>
      <a href="/">ğŸ  Accueil</a>
    </nav>
    <div class="sidebar-bottom">
      <a href="/logout" class="danger">ğŸšª DÃ©connexion</a>
    </div>
  </aside>

  <main class="dash-content">
    <header class="page-header">
      <h1>ğŸ¤– Gestion des Bots</h1>
      <p>Liste complÃ¨te des bots enregistrÃ©s utilisant le systÃ¨me de mise Ã  jour.</p>
      <div style="margin-top:10px;">
        <span class="version-pill">DerniÃ¨re version disponible : <strong><%= latestVersion %></strong></span>
      </div>
    </header>

    <div class="top-actions">
      <button class="btn primary" type="button" onclick="openModal()">â• Ajouter un bot</button>
    </div>

    <section class="bots-grid">
      <% if (bots.length === 0) { %>
        <p class="muted">Aucun bot enregistrÃ©.</p>
      <% } else { %>
        <% bots.forEach(bot => { 
             const stats = bot.stats || {};
             const currentVersion = stats.botVersion || "Inconnue";
             const isUpToDate = currentVersion === latestVersion;
        %>
          <div class="bot-card" data-id="<%= bot._id %>">
            <div class="bot-header">
              <div class="bot-title">
                <span class="bot-name"><%= bot.name %></span>
                <span class="bot-sub">PropriÃ©taire : <%= bot.ownerId || "Inconnu" %></span>
                <span class="bot-sub">Version bot : <%= currentVersion %></span>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                <div>
                  <% if (currentVersion !== "Inconnue") { %>
                    <% if (isUpToDate) { %>
                      <span class="tag tag-success">Ã€ jour</span>
                    <% } else { %>
                      <span class="tag tag-warn">ObsolÃ¨te</span>
                    <% } %>
                  <% } else { %>
                    <span class="tag tag-muted">Aucune info version</span>
                  <% } %>
                </div>
                <div class="bot-actions">
                  <button class="btn small" type="button" onclick="showToken('<%= bot._id %>')">ğŸ” Voir Token</button>
                  <button class="btn small" type="button" onclick="forceRestart('<%= bot._id %>')">ğŸ”„ RedÃ©marrer</button>
                  <button class="btn small" type="button" onclick="forceUpdate('<%= bot._id %>')">â¬† Forcer mÃ j</button>
                  <form action="/owner/bots/<%= bot._id %>/delete" method="POST" style="display:inline;"
                        onsubmit="return confirm('Supprimer ce bot ?');">
                    <button type="submit" class="btn danger small">ğŸ—‘ï¸ Supprimer</button>
                  </form>
                </div>
              </div>
            </div>
            <div class="bot-details">
              <p><strong>AjoutÃ© le :</strong> <%= new Date(bot.createdAt).toLocaleString("fr-FR") %></p>
              <p><strong>Dernier READY :</strong> <%= stats.lastReady ? new Date(stats.lastReady).toLocaleString("fr-FR") : "Jamais" %></p>
              <p><strong>Dernier check :</strong> <%= stats.lastCheck ? new Date(stats.lastCheck).toLocaleString("fr-FR") : "Jamais" %></p>
              <p><strong>RedÃ©marrages :</strong> <%= stats.restarts || 0 %></p>
              <p><strong>Erreurs :</strong> <%= stats.errors || 0 %></p>
              <% if (bot.meta && bot.meta.notes) { %>
                <p><strong>Notes :</strong> <%= bot.meta.notes %></p>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } %>
    </section>
  </main>

  <footer class="footer">
    Â© <%= new Date().getFullYear() %> â€” HOME UPDATE Panel Â·
    <a href="<%= support %>" target="_blank" rel="noopener">Discord</a>
  </footer>

  <!-- Modal ajout bot -->
  <div id="bot-modal" class="modal hidden">
    <div class="modal-box">
      <h2>Ajouter un bot</h2>
      <form action="/owner/bots/add" method="POST">
        <input class="input" type="text" name="name" placeholder="Nom du bot (ex : Smiddy)" required />
        <input class="input" type="text" name="ownerId" placeholder="ID Discord du propriÃ©taire (optionnel)" />
        <input class="input" type="text" name="tokenPlain" placeholder="Token du bot" required />
        <textarea class="input textarea" name="notes" rows="3" placeholder="Notes (serveur, usage, etc.)"></textarea>
        <div class="modal-actions">
          <button type="button" class="btn" onclick="closeModal()">Annuler</button>
          <button type="submit" class="btn primary">Ajouter</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ouverture/fermeture dÃ©tails
    document.querySelectorAll('.bot-header').forEach(h => {
      h.addEventListener('click', (e) => {
        if (e.target.closest('button') || e.target.closest('form')) return;
        h.parentElement.classList.toggle('open');
      });
    });

    // modal
    function openModal() {
      document.getElementById('bot-modal').classList.remove('hidden');
    }
    function closeModal() {
      document.getElementById('bot-modal').classList.add('hidden');
    }

    // voir token
    async function showToken(id) {
      try {
        const res = await fetch(`/owner/bots/${id}/decrypt`);
        if (!res.ok) return alert("Erreur lors de la rÃ©cupÃ©ration du token.");
        const data = await res.json();
        alert(`Token de ${data.name} :\n\n${data.token}`);
      } catch (e) {
        alert("Erreur rÃ©seau lors de la rÃ©cupÃ©ration du token.");
      }
    }

    // ces deux lÃ  sont Ã  implÃ©menter cÃ´tÃ© backend si tu veux qu'ils fassent vraiment quelque chose
    function forceRestart(id) {
      alert("ğŸ”„ Bouton redÃ©marrer : Ã  implÃ©menter cÃ´tÃ© backend (/owner/bots/"+id+"/restart).");
    }

    function forceUpdate(id) {
      alert("â¬† Bouton forcer mise Ã  jour : Ã  implÃ©menter cÃ´tÃ© backend (/owner/bots/"+id+"/force-update).");
    }
  </script>
</body>
</html>
